---
description: å·¥ä½œæµåˆ›å»ºå·¥ä½œæµ - ç”Ÿæˆã€éªŒè¯ã€ä¼˜åŒ–ç¬¦åˆå®˜æ–¹è§„åˆ™çš„å·¥ä½œæµ
---

# Workflow Creation Workflow

> **æ ¸å¿ƒç†å¿µ**: å…ˆç†è§£æ„å›¾ï¼Œå†æ³¨å…¥è§„åˆ™ï¼Œå†è®¾è®¡é€»è¾‘ï¼Œæœ€åéªŒè¯åˆè§„
> **é€‚ç”¨åœºæ™¯**: åˆ›å»ºä»»ä½•æ–°çš„ Antigravity å·¥ä½œæµ

## ğŸš« æ¶æ„çº¦æŸ

> [!CAUTION]
> **ç¦æ­¢è·¨å·¥ä½œæµå¼•ç”¨**
> 
> æœ¬å·¥ä½œæµåŠå…¶è¾“å‡ºçš„æ–°å·¥ä½œæµï¼Œåªèƒ½å¼•ç”¨:
> 1. è‡ªèº«å­æ–‡ä»¶å¤¹ä¸­çš„ Agent
> 2. `.agent/workflows/common/` ä¸­çš„é€šç”¨ Agent
>
> å¦‚éœ€å¤ç”¨èƒ½åŠ› â†’ å‚è€ƒä»£ç æå–æ¨¡å¼ï¼Œæˆ–æ”¾å…¥é€šç”¨æ–‡ä»¶å¤¹

## ğŸ“š Agent Roster

| Agent | æ–‡ä»¶è·¯å¾„ | é˜¶æ®µ |
|-------|---------|------|
| **health-checker** | [health-checker.md](workflow-gen/health-checker.md) | Phase -2 (ä»…ä¼˜åŒ–æ—¶) |
| **intent-analyzer** | [intent-analyzer.md](workflow-gen/intent-analyzer.md) | Phase -1 |
| **rule-injector** | [rule-injector.md](workflow-gen/rule-injector.md) | Phase 0 |
| **resource-scanner** | [resource-scanner.md](workflow-gen/resource-scanner.md) | Phase 0.5 (å¯é€‰) |
| **logic-architect** | [logic-architect.md](workflow-gen/logic-architect.md) | Phase 1 |
| **prompt-engineer** | ä½¿ç”¨ç°æœ‰ `/1-prompt-gen` å·¥ä½œæµ | Phase 2 |
| **compliance-guard** | [compliance-guard.md](workflow-gen/compliance-guard.md) | Phase 3 |

---

## ğŸ“‹ Phase -2: å¥åº·æ£€æŸ¥ (ä»…ä¼˜åŒ–ç°æœ‰å·¥ä½œæµæ—¶è§¦å‘)

Call /health-checker

### è·¯ç”±åˆ¤æ–­

```
å¦‚æœç”¨æˆ·è¯·æ±‚æ˜¯ "åˆ›å»ºæ–°å·¥ä½œæµ":
  â†’ è·³è¿‡ Phase -2ï¼Œç›´æ¥è¿›å…¥ Phase -1
å¦‚æœç”¨æˆ·è¯·æ±‚æ˜¯ "ä¼˜åŒ–/é‡æ„ç°æœ‰å·¥ä½œæµ":
  â†’ æ‰§è¡Œ Phase -2 å¥åº·æ£€æŸ¥
```

### Step -2.1: å¥åº·è¯„ä¼°

**INPUT**: ç°æœ‰å·¥ä½œæµè·¯å¾„ + mode (full/quick)
**OUTPUT**: å¥åº·æ£€æŸ¥ç»“æœ

**æ‰§è¡Œ**:
1. å­—ç¬¦è†¨èƒ€åº¦æ£€æŸ¥ (æƒé‡ 40%)
2. èŒèƒ½å†—ä½™æ£€æµ‹ (æƒé‡ 35%)
3. é€»è¾‘å¥åº·åº¦æ‰«æ (æƒé‡ 25%)

**GATE**:
- æ–‡ä»¶ä¸å­˜åœ¨ â†’ REJECT
- æœ‰ CRITICAL é—®é¢˜ â†’ å±•ç¤ºé—®é¢˜ï¼Œè¯¢é—®ç”¨æˆ·æ˜¯å¦ç»§ç»­
- å¥åº·è¯„åˆ† >= 7.0 â†’ PASSï¼Œè¿›å…¥ Phase -1

### â¸ï¸ CHECKPOINT -2
> **æ£€æŸ¥ç‚¹**: ç¡®è®¤å¥åº·æ£€æŸ¥ç»“æœ
> **é€‰é¡¹**:
> - **"ç»§ç»­ä¼˜åŒ–"** â†’ è¿›å…¥ Phase -1
> - **"ä»…å¿«é€Ÿä¿®å¤"** â†’ ç›´æ¥ä¿®å¤ CRITICAL é—®é¢˜ï¼Œè·³è¿‡å®Œæ•´æµç¨‹
> - **"æ”¾å¼ƒ"** â†’ ç»“æŸ

---

## ğŸ“‹ Phase -1: æ„å›¾ç†è§£

Call /intent-analyzer

### Step -1.1: æå– 5 ä¸ªæ ¸å¿ƒè¦ç´ 

**INPUT**: ç”¨æˆ·çš„è‡ªç„¶è¯­è¨€è¯·æ±‚ (string)
**OUTPUT**: æ„å›¾åˆ†ææŠ¥å‘Š (Markdown, å‚è§ intent-analyzer.md è¾“å‡ºæ ¼å¼)

**æ‰§è¡Œ**:
- æå–å·¥ä½œæµ **åç§°**
- æå–æ ¸å¿ƒ **ç›®æ ‡**
- æå– **è¾“å…¥/è¾“å‡º**
- æå– **å…³é”®çº¦æŸ**
- æå– **æˆåŠŸæ ‡å‡†**

**GATE**: å¦‚æœæœ‰ä»»ä½•è¦ç´ ä¸æ¸…æ¥šï¼Œå¿…é¡»å…ˆè¯¢é—®ç”¨æˆ·

### â¸ï¸ CHECKPOINT -1
> **æ£€æŸ¥ç‚¹**: ç¡®è®¤æ„å›¾ç†è§£æ­£ç¡®ï¼Œæ— æ­§ä¹‰
> **å›å¤**: "ç»§ç»­" æˆ–å›ç­”æ¾„æ¸…é—®é¢˜

---

## ğŸ“‹ Phase 0: è§„åˆ™æ³¨å…¥

Call /rule-injector

### Step 0.1: è¯»å–å®˜æ–¹è§„åˆ™

**INPUT**: æ„å›¾åˆ†ææŠ¥å‘Š (from Phase -1)
**OUTPUT**: å®˜æ–¹è§„åˆ™åŸæ–‡å¼•ç”¨ + å·²çŸ¥å·¥å…·åˆ—è¡¨ (Markdown)

**æ‰§è¡Œ**:
- Read `.agent/rules/v5.md` (å¿…é¡»å­˜åœ¨)
- Read `.agent/rules/*.md` (å…¶ä»–é¢†åŸŸè§„åˆ™)
- æå–å¹¶ **åŸæ–‡å¼•ç”¨** å…³é”®è§„åˆ™ (å¸¦è¡Œå·)
- æå– **å·²çŸ¥å·¥å…·åˆ—è¡¨**

**GATE**: å¦‚æœè¾“å‡ºä¸åŒ…å« "åŸæ–‡:" æ ¼å¼å¼•ç”¨ï¼ŒREJECT

### â¸ï¸ CHECKPOINT 0
> **æ£€æŸ¥ç‚¹**: ç¡®è®¤è§„åˆ™å¼•ç”¨æ­£ç¡®ï¼Œå·¥å…·åˆ—è¡¨å®Œæ•´
> **å›å¤**: "ç»§ç»­" æˆ–æŒ‡å‡ºé—æ¼

---

## ğŸ“‹ Phase 0.5: èµ„æºå‚è€ƒ (å¯é€‰)

Call /resource-scanner

**INPUT**: æ„å›¾åˆ†ææŠ¥å‘Š (from Phase -1)
**OUTPUT**: èµ„æºå‚è€ƒæŠ¥å‘Š (Markdown)

### è·³è¿‡æ¡ä»¶

```
å¦‚æœç”¨æˆ·æ˜ç¡®è¯´ "å¿«é€Ÿåˆ›å»º" æˆ– "ä¸éœ€è¦å‚è€ƒ":
  â†’ è·³è¿‡ Phase 0.5ï¼Œç›´æ¥è¿›å…¥ Phase 1
```

### Step 0.5.1: æ‰«æç›¸å…³èµ„æº

**æ‰§è¡Œ**:
1. æ‰«æ `.agent/workflows/*.md`ï¼Œè¯†åˆ«ç›¸å…³å·¥ä½œæµ
2. é˜…è¯»ç›¸å…³å·¥ä½œæµï¼Œæå–å¯å¤ç”¨æ¨¡å¼
3. æ‰«æé¡¹ç›®ä»£ç åº“ï¼Œè¯†åˆ«çº¦å®šå’Œæ¨¡å¼
4. è¯†åˆ«é€šç”¨ Agent å€™é€‰

**GATE**:
- âŒ REJECT: è¾“å‡ºåŒ…å«è·¨å·¥ä½œæµå¼•ç”¨
- â¸ï¸ PAUSE: å‘ç°é€šç”¨ Agent å€™é€‰ï¼Œè¯¢é—®ç”¨æˆ·
- âœ… PASS: å®Œæˆæ‰«æ

### â¸ï¸ CHECKPOINT 0.5
> **æ£€æŸ¥ç‚¹**: ç¡®è®¤èµ„æºå‚è€ƒå®Œæˆï¼Œæ— è¿è§„å¼•ç”¨
> **é€‰é¡¹**: "ç»§ç»­" / "æŸ¥çœ‹è¯¦æƒ…" / "è·³è¿‡"

---

## ğŸ“‹ Phase 1: é€»è¾‘æ¶æ„

Call /logic-architect

### Step 1.1: å›ç­” 6 ä¸ªå¿…ç­”é—®é¢˜

**INPUT**: æ„å›¾åˆ†ææŠ¥å‘Š + å®˜æ–¹è§„åˆ™ä¸Šä¸‹æ–‡ (from Phase -1, 0)
**OUTPUT**: Workflow Blueprint (Mermaid æµç¨‹å›¾ + 6 ä¸ªé—®é¢˜å›ç­”è¡¨)

**æ‰§è¡Œ**:
- å®šä¹‰å·¥ä½œæµçš„å„ä¸ª Phase
- å›ç­” 6 ä¸ªé€»è¾‘é—®é¢˜:
  1. æ¯ä¸ª Phase çš„ INPUT æ˜¯ä»€ä¹ˆ?
  2. æ¯ä¸ª Phase çš„ OUTPUT æ˜¯ä»€ä¹ˆ?
  3. OUTPUT æ»¡è¶³ä¸‹ä¸€ä¸ª Phase çš„ INPUT å—?
  4. æœ‰æ²¡æœ‰æ¡ä»¶åˆ†æ”¯? æ¯ä¸ªåˆ†æ”¯éƒ½æœ‰é€€å‡ºå—?
  5. æœ‰æ²¡æœ‰é‡å¤çš„ Step?
  6. Agent çœ‹åˆ°æŒ‡ä»¤ä¼šä¸ä¼šæœ‰æ­§ä¹‰?
- ç”Ÿæˆ Mermaid æµç¨‹å›¾

**GATE**: å¦‚æœ 6 ä¸ªé—®é¢˜æ²¡æœ‰å…¨éƒ¨å›ç­”ï¼ŒREJECT

### â¸ï¸ CHECKPOINT 1
> **æ£€æŸ¥ç‚¹**: ç¡®è®¤é€»è¾‘æ¶æ„æ— æ­»å¾ªç¯ã€æ— å†—ä½™ã€æ— æ­§ä¹‰
> **å›å¤**: "ç»§ç»­" æˆ–æŒ‡å‡ºé—®é¢˜

---

## ğŸ“‹ Phase 2: å†…å®¹æ’°å†™

**Agent**: ä½¿ç”¨ç°æœ‰ `/1-prompt-gen` å·¥ä½œæµ
**ä½ç½®**: `.agent/workflows/1-prompt-gen.md`

**Fallback**: å¦‚æœ `/1-prompt-gen` ä¸å¯ç”¨ï¼Œä½¿ç”¨ä»¥ä¸‹å†…è”æŒ‡ä»¤ï¼š
- ä¸ºæ¯ä¸ª Sub-Agent å®šä¹‰ Role + Input + Output
- åº”ç”¨ CoT (Chain-of-Thought) è®©æ¨¡å‹åˆ†æ­¥æ€è€ƒ
- ç›®æ ‡ < 10,000 chars

### Step 2.0: é¢„æ£€ä¸å¤‡ä»½

**æ‰§è¡Œ**:
1. æ£€æŸ¥ `/1-prompt-gen` å·¥ä½œæµæ˜¯å¦å¯ç”¨:
   ```bash
   test -f .agent/workflows/1-prompt-gen.md && echo "âœ… FOUND" || echo "âŒ NOT_FOUND"
   ```
2. æ£€æŸ¥æ˜¯å¦è¦†ç›–ç°æœ‰å·¥ä½œæµï¼Œå¦‚æ˜¯åˆ™å…ˆå¤‡ä»½:
   ```bash
   if [ -f .agent/workflows/{name}.md ]; then
     mkdir -p .agent/workflows/.backup
     cp .agent/workflows/{name}.md .agent/workflows/.backup/{name}.md.bak.$(date +%Y%m%d%H%M%S)
     echo "âœ… å·²å¤‡ä»½åŸæ–‡ä»¶"
   fi
   ```

**GATE**: 
- å¦‚æœ `/1-prompt-gen` NOT_FOUND â†’ ä½¿ç”¨ Fallback å†…è”æŒ‡ä»¤
- å¦‚æœå¤‡ä»½å¤±è´¥ â†’ REJECT

### Step 2.1: è½¬æ¢ä¸º Markdown

**INPUT**: 
- Workflow Blueprint (from Phase 1)
- `iteration_count`: å½“å‰è¿­ä»£è½®æ¬¡ (é¦–æ¬¡=1)

**OUTPUT**: 
- è‰ç¨¿å·¥ä½œæµæ–‡ä»¶ (`.agent/workflows/.draft/{name}.md`)
- `iteration_count`: ä¼ é€’ç»™ Phase 3

**æ‰§è¡Œ**:
- å°† Blueprint è½¬æ¢ä¸º Markdown æ ¼å¼
- æ·»åŠ  YAML Frontmatter
- ä¸ºæ¯ä¸ª Sub-Agent ç¼–å†™æ¸…æ™°æŒ‡ä»¤:
  - æ˜ç¡® **Role** (è§’è‰²)
  - æ˜ç¡® **Input** (è¾“å…¥)
  - æ˜ç¡® **Output** (è¾“å‡º)
- åº”ç”¨ Prompt ä¼˜åŒ–æŠ€å·§ (CoT, Few-Shot)

**çº¦æŸ**: **æ¯ä¸ªæ–‡ä»¶**ç›®æ ‡ < 10,000 chars (ç•™ 2k buffer)

> âš ï¸ **è¾“å‡ºä½ç½®**: è‰ç¨¿è¾“å‡ºåˆ° `.agent/workflows/.draft/`ï¼Œå®¡æ ¸é€šè¿‡åç§»è‡³æ­£å¼ç›®å½•

**é¢„å¤„ç†** (ç¡®ä¿è‰ç¨¿ç›®å½•å­˜åœ¨):
```bash
mkdir -p .agent/workflows/.draft
```

### â¸ï¸ CHECKPOINT 2
> **æ£€æŸ¥ç‚¹**: ç¡®è®¤ Prompt è´¨é‡ (Role/Input/Output æ˜ç¡®)
> **å›å¤**: "ç»§ç»­" æˆ–æŒ‡å‡ºé—®é¢˜

---

## ğŸ“‹ Phase 3: åˆè§„éªŒè¯

Call /compliance-guard

**INPUT**: 
- è‰ç¨¿å·¥ä½œæµæ–‡ä»¶ (from Phase 2, ä½äº `.agent/workflows/.draft/`)
- `iteration_count`: å½“å‰è¿­ä»£è½®æ¬¡

**OUTPUT**: åˆè§„éªŒè¯æŠ¥å‘Š (é€šè¿‡/å¤±è´¥) + `iteration_count`

### Step 3.1: å­—ç¬¦æ£€æŸ¥ (æ¯ä¸ªæ–‡ä»¶å•ç‹¬æ£€æŸ¥)

```bash
# æ£€æŸ¥ä¸»å·¥ä½œæµ
wc -c .agent/workflows/{name}.md
# æ¯ä¸ªæ–‡ä»¶å¿…é¡» < 12,000 chars

# æ£€æŸ¥æ¯ä¸ª Sub-Agent
wc -c .agent/workflows/{name}/*.md
# æ¯ä¸ªæ–‡ä»¶å•ç‹¬ < 12,000 charsï¼Œä¸æ˜¯åŠ æ€»
```

### Step 3.2: 4 ç»´åº¦è¯„åˆ†

| ç»´åº¦ | æƒé‡ |
|------|------|
| è§„åˆ™éµå®ˆåº¦ | 30% |
| é€»è¾‘æ¸…æ™°åº¦ | 25% |
| Prompt è´¨é‡ | 25% |
| å­—ç¬¦æ•ˆç‡ | 20% |

### Step 3.3: è¿­ä»£åˆ¤æ–­

**INPUT**: `iteration_count` from Phase 2

```
å¦‚æœ æ€»åˆ† < 7.0:
  å¦‚æœ iteration_count < 3:
    â†’ è¿”å› Phase 2ï¼Œiteration_count += 1
  å¦åˆ™:
    â†’ æ ‡è®° "éœ€äººå·¥å®¡æ ¸ (å·²è¿­ä»£ 3 æ¬¡)" åè¾“å‡º
å¦‚æœ æ€»åˆ† >= 7.0:
  â†’ âœ… é€šè¿‡ï¼Œè¿›å…¥ Phase 4
```

---

## ğŸ“‹ Phase 4: äººå·¥å®¡æ ¸ (MANDATORY - ä¸å¯è·³è¿‡)

**INPUT**: è‰ç¨¿å·¥ä½œæµæ–‡ä»¶ (ä½äº `.agent/workflows/.draft/`) + åˆè§„éªŒè¯æŠ¥å‘Š
**OUTPUT**: å®¡æ ¸å†³ç­– (åº”ç”¨ / ä¿®æ”¹ / æ”¾å¼ƒ)

### Step 4.0: è‰ç¨¿éªŒè¯

```bash
test -f .agent/workflows/.draft/{name}.md || echo "âŒ è‰ç¨¿ä¸å­˜åœ¨"
```

**GATE**: å¦‚æœè‰ç¨¿ä¸å­˜åœ¨ï¼Œè¿”å› Phase 2

### Step 4.1: å‘ˆç°è‰ç¨¿ä¾›å®¡æ ¸

**æ‰§è¡Œ**:
- å±•ç¤ºè‰ç¨¿å·¥ä½œæµçš„å®Œæ•´å†…å®¹
- å±•ç¤ºåˆè§„éªŒè¯æŠ¥å‘Š (è¯„åˆ† + å­—ç¬¦æ•°)
- **å¦‚æœæ˜¯ä¼˜åŒ–ç°æœ‰å·¥ä½œæµ**:
  - å±•ç¤º Before/After å¯¹æ¯” (diff)
  - è­¦å‘Š: "è¿™å°†è¦†ç›–ç°æœ‰å·¥ä½œæµ"

### â¸ï¸ CHECKPOINT 4 (MANDATORY)
> **æ£€æŸ¥ç‚¹**: äººå·¥å®¡æ ¸è‰ç¨¿å·¥ä½œæµ
> **é€‰é¡¹**:
> - **"åº”ç”¨"** â†’ ç§»åŠ¨è‰ç¨¿åˆ°æ­£å¼ç›®å½•ï¼Œç»§ç»­åˆ° Phase 5
> - **"ä¿®æ”¹"** â†’ ä¿ç•™è‰ç¨¿ï¼Œè¿”å› Phase 2
> - **"æ”¾å¼ƒ"** â†’ **åˆ é™¤è‰ç¨¿**ï¼Œç»“æŸå·¥ä½œæµ

---

## ğŸ“‹ Phase 5: è‰ç¨¿åº”ç”¨ä¸æ¸…ç†

**INPUT**: å®¡æ ¸é€šè¿‡çš„è‰ç¨¿å·¥ä½œæµ (ä½äº `.agent/workflows/.draft/`)
**OUTPUT**: æ­£å¼å·¥ä½œæµæ–‡ä»¶

### Step 5.1: ç§»åŠ¨è‰ç¨¿åˆ°æ­£å¼ç›®å½•

```bash
# ç§»åŠ¨ä¸»æ–‡ä»¶ (å¸¦é”™è¯¯æ£€æŸ¥)
mv .agent/workflows/.draft/{name}.md .agent/workflows/{name}.md || {
  echo "âŒ ç§»åŠ¨ä¸»æ–‡ä»¶å¤±è´¥"
  exit 1
}

# ç§»åŠ¨ Sub-Agent ç›®å½• (å¦‚æœ‰)
if [ -d .agent/workflows/.draft/{name} ]; then
  mv .agent/workflows/.draft/{name} .agent/workflows/{name} || {
    echo "âŒ ç§»åŠ¨ Sub-Agent ç›®å½•å¤±è´¥"
    exit 1
  }
fi
```

### Step 5.2: æ¸…ç†è‰ç¨¿ç›®å½•

```bash
rm -rf .agent/workflows/.draft/{name}*
```

### Step 5.3: å®Œæˆç¡®è®¤

**è¾“å‡º**:
> **âœ… å·¥ä½œæµå·²æ­£å¼åˆ›å»º**: `.agent/workflows/{name}.md`
> **ğŸ“ Sub-Agents**: N ä¸ªæ–‡ä»¶
> **ğŸ’¾ å¤‡ä»½**: [å¦‚æœ‰å¤‡ä»½æ˜¾ç¤ºè·¯å¾„ï¼Œå¦åˆ™æ˜¾ç¤º "æ— "]

---

## âœ… æœ€ç»ˆè¾“å‡º

**è¾“å‡ºä½ç½®**: `.agent/workflows/{name}.md` (ä¸»æ–‡ä»¶) + `.agent/workflows/{name}/*.md` (Sub-Agents)
**è‰ç¨¿ä½ç½®**: `.agent/workflows/.draft/` (ä¸´æ—¶ï¼Œå®Œæˆåæ¸…ç†)
**å¤‡ä»½ä½ç½®**: `.agent/workflows/.backup/` (ä»…è¦†ç›–ç°æœ‰æ—¶)

**è¾“å‡ºå†…å®¹**:
1. å®Œæ•´çš„å·¥ä½œæµ Markdown æ–‡ä»¶ (æ¯ä¸ª < 12,000 chars)
2. åˆè§„éªŒè¯æŠ¥å‘Š
3. (ä»…è¦†ç›–æ—¶) åŸæ–‡ä»¶å¤‡ä»½

---

## Quality Checklist

- [ ] (ä¼˜åŒ–æ—¶) å¥åº·æ£€æŸ¥å®Œæˆï¼Œè¯„åˆ† >= 7.0 æˆ–å·²ç¡®è®¤ (Phase -2)
- [ ] 5 ä¸ªæ„å›¾è¦ç´ å…¨éƒ¨æå– (Phase -1)
- [ ] å®˜æ–¹è§„åˆ™æœ‰åŸæ–‡å¼•ç”¨ (Phase 0)
- [ ] (å¯é€‰) èµ„æºå‚è€ƒå®Œæˆï¼Œæ— è·¨å·¥ä½œæµå¼•ç”¨ (Phase 0.5)
- [ ] 6 ä¸ªå¿…ç­”é—®é¢˜å…¨éƒ¨å›ç­” (Phase 1)
- [ ] æ¯ä¸ª Agent æœ‰ Role/Input/Output (Phase 2)
- [ ] æ¯ä¸ªæ–‡ä»¶å­—ç¬¦ < 12,000 (Phase 3)
- [ ] è¯„åˆ† >= 7.0/10 (Phase 3)
- [ ] **äººå·¥å®¡æ ¸é€šè¿‡ (Phase 4)**
- [ ] (ä¼˜åŒ–æ—¶) åŸæ–‡ä»¶å·²å¤‡ä»½ (Phase 5)
- [ ] YAML Frontmatter æœ‰æ•ˆ

---

**Version**: 1.5 | **Created**: 2025-12-25 | **Updated**: v1.5 - æ–°å¢èµ„æºå‚è€ƒèƒ½åŠ› (resource-scanner) + CPO å†³ç­–èƒ½åŠ› + æ¶æ„çº¦æŸ